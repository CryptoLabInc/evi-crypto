name: evi pull request

on:
  pull_request:
    branches: ["main", "dev*"]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CONDA_CACHE_NUM: 0

jobs:
  precommit-check:
    defaults:
      run:
        shell: bash -l {0}
    runs-on: ubuntu-latest
    env:
      CONDA_ENV_NAME: evi-crypto-dev
      TARGET_SHA: ${{ github.event.pull_request.base.sha }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 2

      - name: Setup conda
        uses: conda-incubator/setup-miniconda@v2
        with:
          miniconda-version: "latest"
          activate-environment: ${{ env.CONDA_ENV_NAME}}

      - name: Get conda env path
        run: |
          echo "CONDA_ENV_PATH=$(bash tools/conda_env.sh)" >> $GITHUB_ENV

      - name: Cache conda env
        id: cache-conda
        uses: actions/cache@v3
        env:
          CONDA_ENV_FILE: conda/${{ env.CONDA_ENV_NAME }}.yml
        with:
          path: ${{ env.CONDA_ENV_PATH }}/${{ env.CONDA_ENV_NAME }}
          key: conda-${{ env.CONDA_ENV_NAME }}-${{ hashFiles(env.CONDA_ENV_FILE) }}-${{ env.CONDA_CACHE_NUM }}

      - name: Update conda env if no cache
        if: ${{ steps.cache-conda.outputs.cache-hit != 'true' }}
        run: conda env update -n ${{ env.CONDA_ENV_NAME }} -f conda/${{ env.CONDA_ENV_NAME }}.yml

      - name: Install pre-commit to the current repo
        run: pre-commit install

      - name: Cache build deps and compile_commands
        id: cache-build-deps
        uses: actions/cache@v4
        with:
          path: |
            build/_deps
            build/compile_commands.json
          key: deps-${{ hashFiles('CMakeLists.txt', 'external/**') }}

      - name: Configure (populate compile_commands)
        run: cmake -S . -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build light targets (populate _deps)
        run: cmake --build build --target debparam || cmake --build build

      - name: Run pre-commit for commit and push stages.
        run: pre-commit run --from-ref "$TARGET_SHA" --to-ref HEAD --hook-stage commit --hook-stage push

  test-evi-crypto:
    defaults:
      run:
        shell: bash -l {0}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        PRESET: [test]
        TEST_PRESET: [all-test]
    env:
      CONDA_ENV_NAME: evi-crypto-dev

    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}

      - name: Setup conda
        uses: conda-incubator/setup-miniconda@v2
        with:
          miniconda-version: "latest"
          activate-environment: ${{ env.CONDA_ENV_NAME }}

      - name: Get conda env path
        run: |
          echo "CONDA_ENV_PATH=$(bash tools/conda_env.sh)" >> $GITHUB_ENV

      - name: Cache conda env
        id: cache-conda
        uses: actions/cache@v3
        env:
          CONDA_ENV_FILE: conda/${{ env.CONDA_ENV_NAME }}.yml
        with:
          path: ${{ env.CONDA_ENV_PATH }}/${{ env.CONDA_ENV_NAME }}
          key: conda-${{ env.CONDA_ENV_NAME }}-${{ hashFiles(env.CONDA_ENV_FILE) }}-${{ env.CONDA_CACHE_NUM }}

      - name: Update conda env if no cache
        if: ${{ steps.cache-conda.outputs.cache-hit != 'true' }}
        run: conda env update -n ${{ env.CONDA_ENV_NAME }} -f conda/${{ env.CONDA_ENV_NAME }}.yml

      - name: Configure CMake and Build
        run: |
          cmake --preset ${{ matrix.PRESET }}
          cmake --build --preset ${{ matrix.PRESET }} --parallel

      - name: Test operations
        run: ctest --preset ${{ matrix.TEST_PRESET }}

  test-c-api:
    name: test-c-api
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: "1"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          driver: docker-container
          use: false
          name: evi-builder-${{ github.run_id }}-linux
          cleanup: true

      - name: Build c-api test docker image
        run: |
          docker buildx build \
            --no-cache \
            -f docker/c_api/Dockerfile \
            --builder ${{ steps.buildx.outputs.name }} \
            --target test-all \
            -t evi/c-api:${{ github.sha }} \
            --provenance=false \
            --sbom=false \
            --load .

      - name: Build and Test CPU c-api
        run: |
          docker run --rm evi/c-api:${{ github.sha }} /workspace/cpu/evi_c_api_test

      - name: Build c-api docker image
        run: |
          docker buildx build \
            -f docker/c_api/Dockerfile \
            --builder ${{ steps.buildx.outputs.name }} \
            --target c-binary-all \
            -t evi/c-api:${{ github.sha }} \
            --provenance=false \
            --sbom=false \
            --load .

      - name: Cleanup
        if: always()
        run: |
          docker rmi evi/c-api:${{ github.sha }} || true

  test-pybind:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: "recursive"

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Set up evi pybind (Linux)
        run: |
          pip wheel . --no-deps -w dist -Cbuild-dir=build
          pip install dist/evi-*.whl --force-reinstall
          pip install pytest numpy
          pytest . -v
